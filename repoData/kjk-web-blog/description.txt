This is a simple blog engine and my personal website running at
http://blog.kowalczyk.info

It's written in Go. Doesn't require a database as all data is stored in files.

The code was written by Krzysztof Kowalczyk and is placed in
public domain.


<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type=text/css> 
pre,code {font-size:9pt; font:Consolas,Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;}
.c { background-color: #96EBA6; }
</style>
</head>
<body>
<pre><a href="index.html">Home</a> : csharp\src\impl\ClassDescriptor.cs</pre>
<table cellpadding="0" cellspacing="0">
<tbody>
  <tr>
  <td style="margin:0px; vertical-align:top">
  <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>

  </pre>
  </td>

  <td  style="margin:0px; padding-left:8px; vertical-align:top" width="100%">
  <pre><div class="line" id="l1">namespace NachoDB.Impl
</div><div class="line" id="l2">{
</div><div class="line" id="l3">    using System;
</div><div class="line" id="l4">    using System.Collections;
</div><div class="line" id="l5">    using System.Reflection;
</div><div class="line" id="l6">    using System.Runtime.InteropServices;
</div><div class="line" id="l7">    using System.Diagnostics;
</div><div class="line" id="l8">    using System.Text;
</div><div class="line" id="l9">    using NachoDB;
</div><div class="line" id="l10"><br></div><div class="line" id="l11">    public sealed class ClassDescriptor : Persistent
</div><div class="line" id="l12">    {
</div><div class="line" id="l13">        internal ClassDescriptor   next;
</div><div class="line" id="l14">        internal String            name;
</div><div class="line" id="l15">        internal FieldDescriptor[] allFields;
</div><div class="line" id="l16">        internal bool              hasReferences;
</div><div class="line" id="l17">        internal static Module     lastModule;
</div><div class="line" id="l18"><br></div><div class="line" id="l19">        public class FieldDescriptor : Persistent 
</div><div class="line" id="l20">        { 
</div><div class="line" id="l21">            internal String          fieldName;
</div><div class="line" id="l22">            internal String          className;
</div><div class="line" id="l23">            internal FieldType       type;
</div><div class="line" id="l24">            internal ClassDescriptor valueDesc;
</div><div class="line" id="l25">            [NonSerialized()]
</div><div class="line" id="l26">            internal FieldInfo       field;
</div><div class="line" id="l27">            [NonSerialized()]
</div><div class="line" id="l28">            internal bool            recursiveLoading;
</div><div class="line" id="l29">            [NonSerialized()]
</div><div class="line" id="l30">            internal MethodInfo constructor;
</div><div class="line" id="l31"><br></div><div class="line" id="l32">            public bool equals(FieldDescriptor fd) 
</div><div class="line" id="l33">            { 
</div><div class="line" id="l34">                <span class="c">return fieldName.Equals(fd.fieldName)</span></div><div class="line" id="l35"><span class="c">                    &amp;&amp; className.Equals(fd.className)</span></div><div class="line" id="l36"><span class="c">                    &amp;&amp; valueDesc == fd.valueDesc</span></div><div class="line" id="l37">                    &amp;&amp; type == fd.type<span class="c">;</span></div><div class="line" id="l38">            }
</div><div class="line" id="l39">        }    
</div><div class="line" id="l40">        [NonSerialized()]
</div><div class="line" id="l41">        internal Type cls;
</div><div class="line" id="l42">        [NonSerialized()]
</div><div class="line" id="l43">        internal bool hasSubclasses;
</div><div class="line" id="l44">        [NonSerialized()]
</div><div class="line" id="l45">        internal ConstructorInfo defaultConstructor;
</div><div class="line" id="l46">        [NonSerialized()]
</div><div class="line" id="l47">        internal bool resolved;
</div><div class="line" id="l48">        [NonSerialized()]
</div><div class="line" id="l49">        internal GeneratedSerializer serializer;
</div><div class="line" id="l50"><br></div><div class="line" id="l51">        internal static bool serializeNonPersistentObjects;
</div><div class="line" id="l52"><br></div><div class="line" id="l53">        public enum FieldType 
</div><div class="line" id="l54">        {
</div><div class="line" id="l55">            tpBoolean,
</div><div class="line" id="l56">            tpByte,
</div><div class="line" id="l57">            tpSByte,
</div><div class="line" id="l58">            tpShort, 
</div><div class="line" id="l59">            tpUShort,
</div><div class="line" id="l60">            tpChar,
</div><div class="line" id="l61">            tpEnum,
</div><div class="line" id="l62">            tpInt,
</div><div class="line" id="l63">            tpUInt,
</div><div class="line" id="l64">            tpLong,
</div><div class="line" id="l65">            tpULong,
</div><div class="line" id="l66">            tpFloat,
</div><div class="line" id="l67">            tpDouble,
</div><div class="line" id="l68">            tpString,
</div><div class="line" id="l69">            tpDate,
</div><div class="line" id="l70">            tpObject,
</div><div class="line" id="l71">            tpOid,
</div><div class="line" id="l72">            tpValue,
</div><div class="line" id="l73">            tpRaw,
</div><div class="line" id="l74">            tpGuid,
</div><div class="line" id="l75">            tpDecimal,
</div><div class="line" id="l76">            tpLink,
</div><div class="line" id="l77">            tpArrayOfBoolean,
</div><div class="line" id="l78">            tpArrayOfByte,
</div><div class="line" id="l79">            tpArrayOfSByte,
</div><div class="line" id="l80">            tpArrayOfShort, 
</div><div class="line" id="l81">            tpArrayOfUShort,
</div><div class="line" id="l82">            tpArrayOfChar,
</div><div class="line" id="l83">            tpArrayOfEnum,
</div><div class="line" id="l84">            tpArrayOfInt,
</div><div class="line" id="l85">            tpArrayOfUInt,
</div><div class="line" id="l86">            tpArrayOfLong,
</div><div class="line" id="l87">            tpArrayOfULong,
</div><div class="line" id="l88">            tpArrayOfFloat,
</div><div class="line" id="l89">            tpArrayOfDouble,
</div><div class="line" id="l90">            tpArrayOfString,
</div><div class="line" id="l91">            tpArrayOfDate,
</div><div class="line" id="l92">            tpArrayOfObject,
</div><div class="line" id="l93">            tpArrayOfOid,
</div><div class="line" id="l94">            tpArrayOfValue,
</div><div class="line" id="l95">            tpArrayOfRaw,
</div><div class="line" id="l96">            tpArrayOfGuid,
</div><div class="line" id="l97">            tpArrayOfDecimal,
</div><div class="line" id="l98">            tpLast
</div><div class="line" id="l99">        }
</div><div class="line" id="l100"><br></div><div class="line" id="l101">        <span class="c">internal static int[] Sizeof = new int[]</span></div><div class="line" id="l102"><span class="c">        {</span></div><div class="line" id="l103"><span class="c">            1, // tpBoolean,</span></div><div class="line" id="l104"><span class="c">            1, // tpByte,</span></div><div class="line" id="l105"><span class="c">            1, // tpSByte,</span></div><div class="line" id="l106"><span class="c">            2, // tpShort,</span></div><div class="line" id="l107"><span class="c">            2, // tpUShort,</span></div><div class="line" id="l108"><span class="c">            2, // tpChar,</span></div><div class="line" id="l109"><span class="c">            4, // tpEnum,</span></div><div class="line" id="l110"><span class="c">            4, // tpInt,</span></div><div class="line" id="l111"><span class="c">            4, // tpUInt,</span></div><div class="line" id="l112"><span class="c">            8, // tpLong,</span></div><div class="line" id="l113"><span class="c">            8, // tpULong,</span></div><div class="line" id="l114"><span class="c">            4, // tpFloat,</span></div><div class="line" id="l115"><span class="c">            8, // tpDouble,</span></div><div class="line" id="l116"><span class="c">            0, // tpString,</span></div><div class="line" id="l117"><span class="c">            8, // tpDate,</span></div><div class="line" id="l118"><span class="c">            4, // tpObject,</span></div><div class="line" id="l119"><span class="c">            4, // tpOid,</span></div><div class="line" id="l120"><span class="c">            0, // tpValue,</span></div><div class="line" id="l121"><span class="c">            0, // tpRaw,</span></div><div class="line" id="l122"><span class="c">            16,// tpGuid,</span></div><div class="line" id="l123"><span class="c">            16,// tpDecimal,</span></div><div class="line" id="l124"><span class="c">            0, // tpLink,</span></div><div class="line" id="l125"><span class="c">            0, // tpArrayOfBoolean,</span></div><div class="line" id="l126"><span class="c">            0, // tpArrayOfByte,</span></div><div class="line" id="l127"><span class="c">            0, // tpArrayOfSByte,</span></div><div class="line" id="l128"><span class="c">            0, // tpArrayOfShort,</span></div><div class="line" id="l129"><span class="c">            0, // tpArrayOfUShort,</span></div><div class="line" id="l130"><span class="c">            0, // tpArrayOfChar,</span></div><div class="line" id="l131"><span class="c">            0, // tpArrayOfEnum,</span></div><div class="line" id="l132"><span class="c">            0, // tpArrayOfInt,</span></div><div class="line" id="l133"><span class="c">            0, // tpArrayOfUInt,</span></div><div class="line" id="l134"><span class="c">            0, // tpArrayOfLong,</span></div><div class="line" id="l135"><span class="c">            0, // tpArrayOfULong,</span></div><div class="line" id="l136"><span class="c">            0, // tpArrayOfFloat,</span></div><div class="line" id="l137"><span class="c">            0, // tpArrayOfDouble,</span></div><div class="line" id="l138"><span class="c">            0, // tpArrayOfString,</span></div><div class="line" id="l139"><span class="c">            0, // tpArrayOfDate,</span></div><div class="line" id="l140"><span class="c">            0, // tpArrayOfObject,</span></div><div class="line" id="l141"><span class="c">            0, // tpArrayOfOid,</span></div><div class="line" id="l142"><span class="c">            0, // tpArrayOfValue,</span></div><div class="line" id="l143"><span class="c">            0, // tpArrayOfRaw,</span></div><div class="line" id="l144"><span class="c">            0, // tpArrayOfGuid,</span></div><div class="line" id="l145"><span class="c">            0  // tpArrayOfDecimal,</span></div><div class="line" id="l146">        }<span class="c">;</span></div><div class="line" id="l147"><br></div><div class="line" id="l148">        <span class="c">internal static Type[] defaultConstructorProfile = new Type[0];</span></div><div class="line" id="l149">        <span class="c">internal static object[] noArgs = new object[0];</span></div><div class="line" id="l150"><br></div><div class="line" id="l151">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l152">        static internal object parseEnum(Type type, String value) 
</div><div class="line" id="l153">        {
</div><div class="line" id="l154">            foreach (FieldInfo fi in type.GetFields()) 
</div><div class="line" id="l155">            {
</div><div class="line" id="l156">                if (fi.IsLiteral &amp;&amp; fi.Name.Equals(value)) 
</div><div class="line" id="l157">                {
</div><div class="line" id="l158">                    return fi.GetValue(null);
</div><div class="line" id="l159">                }
</div><div class="line" id="l160">            }
</div><div class="line" id="l161">            throw new ArgumentException(value);
</div><div class="line" id="l162">        }
</div><div class="line" id="l163">#endif
</div><div class="line" id="l164"><br></div><div class="line" id="l165">        public bool equals(ClassDescriptor cd) 
</div><div class="line" id="l166">        { 
</div><div class="line" id="l167">            <span class="c">if (cd == null || allFields.Length != cd.allFields.Length)</span></div><div class="line" id="l168">            { 
</div><div class="line" id="l169">                <span class="c">return false;</span></div><div class="line" id="l170">            }
</div><div class="line" id="l171">            for (<span class="c">int i = 0;</span> <span class="c">i &lt; allFields.Length</span>; <span class="c">i++</span>)</div><div class="line" id="l172">            { 
</div><div class="line" id="l173">                <span class="c">if (!allFields[i].equals(cd.allFields[i]))</span></div><div class="line" id="l174">                { 
</div><div class="line" id="l175">                    <span class="c">return false;</span></div><div class="line" id="l176">                }
</div><div class="line" id="l177">            }
</div><div class="line" id="l178">            <span class="c">return true;</span></div><div class="line" id="l179">        }
</div><div class="line" id="l180"><br></div><div class="line" id="l181">        internal Object newInstance()
</div><div class="line" id="l182">        {
</div><div class="line" id="l183">            try
</div><div class="line" id="l184">            {
</div><div class="line" id="l185">                <span class="c">return defaultConstructor.Invoke(noArgs);</span></div><div class="line" id="l186">            }
</div><div class="line" id="l187">            <span class="c">catch (System.Exception x)</span></div><div class="line" id="l188">            {
</div><div class="line" id="l189">                <span class="c">throw new StorageError(StorageError.ErrorCode.CONSTRUCTOR_FAILURE, cls, x);</span></div><div class="line" id="l190">            }
</div><div class="line" id="l191">        <span class="c">}</span></div><div class="line" id="l192"><br></div><div class="line" id="l193">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l194">        internal void generateSerializer() {}
</div><div class="line" id="l195">#else
</div><div class="line" id="l196">        <span class="c">private static CodeGenerator serializerGenerator = CodeGenerator.Instance;</span></div><div class="line" id="l197"><br></div><div class="line" id="l198">        internal void generateSerializer()
</div><div class="line" id="l199">        {
</div><div class="line" id="l200">            <span class="c">if (!cls.IsPublic || defaultConstructor == null || !defaultConstructor.IsPublic)</span></div><div class="line" id="l201">            { 
</div><div class="line" id="l202">                <span class="c">return;</span></div><div class="line" id="l203">            }
</div><div class="line" id="l204">            <span class="c">FieldDescriptor[] flds = allFields;</span></div><div class="line" id="l205">            for (<span class="c">int i = 0,</span> <span class="c">n = flds.Length;</span> <span class="c">i &lt; n</span>; <span class="c">i++</span>)</div><div class="line" id="l206">            {
</div><div class="line" id="l207">                <span class="c">FieldDescriptor fd = flds[i];</span></div><div class="line" id="l208">                <span class="c">switch (fd.type)</span></div><div class="line" id="l209">                { 
</div><div class="line" id="l210">                    case FieldType.tpValue:
</div><div class="line" id="l211">                    case FieldType.tpArrayOfValue:
</div><div class="line" id="l212">                    case FieldType.tpArrayOfObject:
</div><div class="line" id="l213">                    case FieldType.tpArrayOfEnum:
</div><div class="line" id="l214">                    case FieldType.tpArrayOfRaw:
</div><div class="line" id="l215">                    case FieldType.tpLink:
</div><div class="line" id="l216">                    case FieldType.tpArrayOfOid:
</div><div class="line" id="l217"><br></div><div class="line" id="l218">                        <span class="c">return;</span></div><div class="line" id="l219">                    default:
</div><div class="line" id="l220">                        break;
</div><div class="line" id="l221">                }
</div><div class="line" id="l222">                <span class="c">FieldInfo f = flds[i].field;</span></div><div class="line" id="l223">                <span class="c">if (f == null || !f.IsPublic)</span></div><div class="line" id="l224">                {
</div><div class="line" id="l225">                    <span class="c">return;</span></div><div class="line" id="l226">                }
</div><div class="line" id="l227">            }
</div><div class="line" id="l228">            <span class="c">serializer = serializerGenerator.Generate(this);</span></div><div class="line" id="l229">        <span class="c">}</span></div><div class="line" id="l230"><br></div><div class="line" id="l231">        static private bool isObjectProperty(Type cls, FieldInfo f)
</div><div class="line" id="l232">        {
</div><div class="line" id="l233">            return typeof(PersistentWrapper).IsAssignableFrom(cls) &amp;&amp; f.Name.StartsWith("r_");
</div><div class="line" id="l234">        }
</div><div class="line" id="l235">#endif
</div><div class="line" id="l236"><br></div><div class="line" id="l237">        MethodInfo GetConstructor(FieldInfo f, string name)
</div><div class="line" id="l238">        { 
</div><div class="line" id="l239">            <span class="c">MethodInfo mi = typeof(StorageImpl).GetMethod(name, BindingFlags.Instance|BindingFlags.NonPublic|BindingFlags.DeclaredOnly);</span></div><div class="line" id="l240">            //return mi.BindGenericParameters(f.FieldType.GetGenericArguments());
</div><div class="line" id="l241">            //TODO: verify it's MakeGenericMethod
</div><div class="line" id="l242">            <span class="c">return mi.MakeGenericMethod(f.FieldType.GetGenericArguments());</span></div><div class="line" id="l243">        }
</div><div class="line" id="l244"><br></div><div class="line" id="l245">        internal static String getTypeName(Type t)
</div><div class="line" id="l246">        {
</div><div class="line" id="l247">            <span class="c">if (t.IsGenericType)</span></div><div class="line" id="l248">            { 
</div><div class="line" id="l249">                <span class="c">Type[] genericArgs = t.GetGenericArguments();</span></div><div class="line" id="l250">                <span class="c">t = t.GetGenericTypeDefinition();</span></div><div class="line" id="l251">                <span class="c">StringBuilder buf = new StringBuilder(t.FullName);</span></div><div class="line" id="l252">                <span class="c">buf.Append('=');</span></div><div class="line" id="l253">                <span class="c">char sep = '[';</span></div><div class="line" id="l254">                for (<span class="c">int j = 0;</span> <span class="c">j &lt; genericArgs.Length</span>; <span class="c">j++</span>)</div><div class="line" id="l255">                { 
</div><div class="line" id="l256">                     <span class="c">buf.Append(sep);</span></div><div class="line" id="l257">                     <span class="c">sep = ',';</span></div><div class="line" id="l258">                     <span class="c">buf.Append(getTypeName(genericArgs[j]));</span></div><div class="line" id="l259">                }
</div><div class="line" id="l260">                <span class="c">buf.Append(']');</span></div><div class="line" id="l261">                <span class="c">return buf.ToString();</span></div><div class="line" id="l262">            }
</div><div class="line" id="l263">            <span class="c">return t.FullName;</span></div><div class="line" id="l264">        }
</div><div class="line" id="l265"><br></div><div class="line" id="l266">        static bool isPerstInternalType(Type t)
</div><div class="line" id="l267">        {
</div><div class="line" id="l268">            return t.Namespace == typeof(IPersistent).Namespace
</div><div class="line" id="l269">                &amp;&amp; t != typeof(IPersistent) &amp;&amp; t != typeof(PersistentContext) &amp;&amp; t != typeof(Persistent);
</div><div class="line" id="l270">        }
</div><div class="line" id="l271"><br></div><div class="line" id="l272">        internal void  buildFieldList(StorageImpl storage, System.Type cls, ArrayList list)
</div><div class="line" id="l273">        {
</div><div class="line" id="l274">            <span class="c">System.Type superclass = cls.BaseType;</span></div><div class="line" id="l275">            <span class="c">if (superclass != null &amp;&amp; superclass != typeof(MarshalByRefObject))</span></div><div class="line" id="l276">            {
</div><div class="line" id="l277">                <span class="c">buildFieldList(storage, superclass, list);</span></div><div class="line" id="l278">            }
</div><div class="line" id="l279">            <span class="c">System.Reflection.FieldInfo[] flds = cls.GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.DeclaredOnly);</span></div><div class="line" id="l280">#if !COMPACT_NET_FRAMEWORK 
</div><div class="line" id="l281">            <span class="c">bool isWrapper = typeof(PersistentWrapper).IsAssignableFrom(cls);</span></div><div class="line" id="l282">#endif
</div><div class="line" id="l283">            <span class="c">bool hasTransparentAttribute = cls.GetCustomAttributes(typeof(TransparentPersistenceAttribute), true).Length != 0;</span></div><div class="line" id="l284"><br></div><div class="line" id="l285">            for (<span class="c">int i = 0;</span> <span class="c">i &lt; flds.Length</span>; <span class="c">i++</span>)</div><div class="line" id="l286">            {
</div><div class="line" id="l287">                <span class="c">FieldInfo f = flds[i];</span></div><div class="line" id="l288">                <span class="c">if (!f.IsNotSerialized &amp;&amp; !f.IsStatic)</span></div><div class="line" id="l289">                {
</div><div class="line" id="l290">                    <span class="c">FieldDescriptor fd = new FieldDescriptor();</span></div><div class="line" id="l291">                    <span class="c">fd.field = f;</span></div><div class="line" id="l292">                    <span class="c">fd.fieldName = f.Name;</span></div><div class="line" id="l293">                    <span class="c">fd.className = getTypeName(cls);</span></div><div class="line" id="l294">                    <span class="c">Type fieldType = f.FieldType;</span></div><div class="line" id="l295">                    <span class="c">FieldType type = getTypeCode(fieldType);</span></div><div class="line" id="l296">                    <span class="c">switch (type)</span></div><div class="line" id="l297">                    {
</div><div class="line" id="l298">#if !COMPACT_NET_FRAMEWORK 
</div><div class="line" id="l299">                        case FieldType.tpInt:
</div><div class="line" id="l300">                            <span class="c">if (isWrapper &amp;&amp; isObjectProperty(cls, f))</span></div><div class="line" id="l301">                            {
</div><div class="line" id="l302">                                <span class="c">hasReferences = true;</span></div><div class="line" id="l303">                                <span class="c">type = FieldType.tpOid;</span></div><div class="line" id="l304">                            } 
</div><div class="line" id="l305">                            <span class="c">break;</span></div><div class="line" id="l306">#endif
</div><div class="line" id="l307">                        case FieldType.tpArrayOfOid:
</div><div class="line" id="l308">                            <span class="c">fd.constructor = GetConstructor(f, "ConstructArray");</span></div><div class="line" id="l309">                            <span class="c">hasReferences = true;</span></div><div class="line" id="l310">                            <span class="c">break;</span></div><div class="line" id="l311">                        case FieldType.tpLink:
</div><div class="line" id="l312">                            <span class="c">fd.constructor = GetConstructor(f, "ConstructLink");</span></div><div class="line" id="l313">                            <span class="c">hasReferences = true;</span></div><div class="line" id="l314">                            <span class="c">break;</span></div><div class="line" id="l315"><br></div><div class="line" id="l316">                        case FieldType.tpArrayOfObject:
</div><div class="line" id="l317">                        case FieldType.tpObject:
</div><div class="line" id="l318">                            <span class="c">hasReferences = true;</span></div><div class="line" id="l319">                            <span class="c">if (hasTransparentAttribute &amp;&amp; isPerstInternalType(fieldType))</span></div><div class="line" id="l320">                            {
</div><div class="line" id="l321">                                <span class="c">fd.recursiveLoading = true;</span></div><div class="line" id="l322">                            }
</div><div class="line" id="l323">                            <span class="c">break;</span></div><div class="line" id="l324">                        case FieldType.tpValue:
</div><div class="line" id="l325">                            <span class="c">fd.valueDesc = storage.getClassDescriptor(f.FieldType);</span></div><div class="line" id="l326">                            <span class="c">hasReferences |= fd.valueDesc.hasReferences;</span></div><div class="line" id="l327">                            <span class="c">break;</span></div><div class="line" id="l328">                        case FieldType.tpArrayOfValue:
</div><div class="line" id="l329">                            <span class="c">fd.valueDesc = storage.getClassDescriptor(f.FieldType.GetElementType());</span></div><div class="line" id="l330">                            <span class="c">hasReferences |= fd.valueDesc.hasReferences;</span></div><div class="line" id="l331">                            break;
</div><div class="line" id="l332">                    }
</div><div class="line" id="l333">                    <span class="c">fd.type = type;</span></div><div class="line" id="l334">                    <span class="c">list.Add(fd);</span></div><div class="line" id="l335">                }
</div><div class="line" id="l336">            }
</div><div class="line" id="l337">        <span class="c">}</span></div><div class="line" id="l338"><br></div><div class="line" id="l339">        public static FieldType getTypeCode(System.Type c)
</div><div class="line" id="l340">        {
</div><div class="line" id="l341">            FieldType type;
</div><div class="line" id="l342">            <span class="c">if (c.Equals(typeof(byte)))</span></div><div class="line" id="l343">            {
</div><div class="line" id="l344">                <span class="c">type = FieldType.tpByte;</span></div><div class="line" id="l345">            }
</div><div class="line" id="l346">            else <span class="c">if (c.Equals(typeof(sbyte)))</span></div><div class="line" id="l347">            {
</div><div class="line" id="l348">                <span class="c">type = FieldType.tpSByte;</span></div><div class="line" id="l349">            }
</div><div class="line" id="l350">            else <span class="c">if (c.Equals(typeof(short)))</span></div><div class="line" id="l351">            {
</div><div class="line" id="l352">                <span class="c">type = FieldType.tpShort;</span></div><div class="line" id="l353">            }
</div><div class="line" id="l354">            else <span class="c">if (c.Equals(typeof(ushort)))</span></div><div class="line" id="l355">            {
</div><div class="line" id="l356">                <span class="c">type = FieldType.tpUShort;</span></div><div class="line" id="l357">            }
</div><div class="line" id="l358">            else <span class="c">if (c.Equals(typeof(char)))</span></div><div class="line" id="l359">            {
</div><div class="line" id="l360">                <span class="c">type = FieldType.tpChar;</span></div><div class="line" id="l361">            }
</div><div class="line" id="l362">            else <span class="c">if (c.Equals(typeof(int)))</span></div><div class="line" id="l363">            {
</div><div class="line" id="l364">                <span class="c">type = FieldType.tpInt;</span></div><div class="line" id="l365">            }
</div><div class="line" id="l366">            else <span class="c">if (c.Equals(typeof(uint)))</span></div><div class="line" id="l367">            {
</div><div class="line" id="l368">                <span class="c">type = FieldType.tpUInt;</span></div><div class="line" id="l369">            }
</div><div class="line" id="l370">            else <span class="c">if (c.Equals(typeof(long)))</span></div><div class="line" id="l371">            {
</div><div class="line" id="l372">                <span class="c">type = FieldType.tpLong;</span></div><div class="line" id="l373">            }
</div><div class="line" id="l374">            else <span class="c">if (c.Equals(typeof(ulong)))</span></div><div class="line" id="l375">            {
</div><div class="line" id="l376">                <span class="c">type = FieldType.tpULong;</span></div><div class="line" id="l377">            }
</div><div class="line" id="l378">            else <span class="c">if (c.Equals(typeof(float)))</span></div><div class="line" id="l379">            {
</div><div class="line" id="l380">                <span class="c">type = FieldType.tpFloat;</span></div><div class="line" id="l381">            }
</div><div class="line" id="l382">            else <span class="c">if (c.Equals(typeof(double)))</span></div><div class="line" id="l383">            {
</div><div class="line" id="l384">                <span class="c">type = FieldType.tpDouble;</span></div><div class="line" id="l385">            }
</div><div class="line" id="l386">            else <span class="c">if (c.Equals(typeof(System.String)))</span></div><div class="line" id="l387">            {
</div><div class="line" id="l388">                <span class="c">type = FieldType.tpString;</span></div><div class="line" id="l389">            }
</div><div class="line" id="l390">            else <span class="c">if (c.Equals(typeof(bool)))</span></div><div class="line" id="l391">            {
</div><div class="line" id="l392">                <span class="c">type = FieldType.tpBoolean;</span></div><div class="line" id="l393">            }
</div><div class="line" id="l394">            else <span class="c">if (c.Equals(typeof(System.DateTime)))</span></div><div class="line" id="l395">            {
</div><div class="line" id="l396">                <span class="c">type = FieldType.tpDate;</span></div><div class="line" id="l397">            }
</div><div class="line" id="l398">            else <span class="c">if (c.IsEnum)</span></div><div class="line" id="l399">            { 
</div><div class="line" id="l400">                <span class="c">type = FieldType.tpEnum;</span></div><div class="line" id="l401">            }
</div><div class="line" id="l402">            else <span class="c">if (c.Equals(typeof(decimal)))</span></div><div class="line" id="l403">            { 
</div><div class="line" id="l404">                <span class="c">type = FieldType.tpDecimal;</span></div><div class="line" id="l405">            }
</div><div class="line" id="l406">            else <span class="c">if (c.Equals(typeof(Guid)))</span></div><div class="line" id="l407">            { 
</div><div class="line" id="l408">                <span class="c">type = FieldType.tpGuid;</span></div><div class="line" id="l409">            }
</div><div class="line" id="l410">            else <span class="c">if (typeof(IPersistent).IsAssignableFrom(c))</span></div><div class="line" id="l411">            {
</div><div class="line" id="l412">                <span class="c">type = FieldType.tpObject;</span></div><div class="line" id="l413">            }
</div><div class="line" id="l414">            else <span class="c">if (typeof(ValueType).IsAssignableFrom(c))</span></div><div class="line" id="l415">            {
</div><div class="line" id="l416">                <span class="c">type = FieldType.tpValue;</span></div><div class="line" id="l417">            }
</div><div class="line" id="l418">            else <span class="c">if (typeof(GenericPArray).IsAssignableFrom(c))</span></div><div class="line" id="l419">            {
</div><div class="line" id="l420">                <span class="c">type = FieldType.tpArrayOfOid;</span></div><div class="line" id="l421">            }
</div><div class="line" id="l422">            else <span class="c">if (typeof(GenericLink).IsAssignableFrom(c))</span></div><div class="line" id="l423">            {
</div><div class="line" id="l424">                <span class="c">type = FieldType.tpLink;</span></div><div class="line" id="l425">            }
</div><div class="line" id="l426">            else <span class="c">if (c.IsArray)</span></div><div class="line" id="l427">            {
</div><div class="line" id="l428">                <span class="c">type = getTypeCode(c.GetElementType());</span></div><div class="line" id="l429">                <span class="c">if ((int)type &gt;= (int)FieldType.tpLink)</span></div><div class="line" id="l430">                {
</div><div class="line" id="l431">                    <span class="c">throw new StorageError(StorageError.ErrorCode.UNSUPPORTED_TYPE, c);</span></div><div class="line" id="l432">                }
</div><div class="line" id="l433">                <span class="c">type = (FieldType)((int)type + (int)FieldType.tpArrayOfBoolean);</span></div><div class="line" id="l434">            }
</div><div class="line" id="l435">            else
</div><div class="line" id="l436">            {
</div><div class="line" id="l437">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l438">                <span class="c">if (serializeNonPersistentObjects || c == typeof(object) || c == typeof(IComparable))</span></div><div class="line" id="l439">                {
</div><div class="line" id="l440">                    <span class="c">type = FieldType.tpRaw;</span></div><div class="line" id="l441">                } 
</div><div class="line" id="l442">                else 
</div><div class="line" id="l443">                { 
</div><div class="line" id="l444">                    <span class="c">throw new StorageError(StorageError.ErrorCode.UNSUPPORTED_TYPE, c);</span></div><div class="line" id="l445">                }
</div><div class="line" id="l446">#else
</div><div class="line" id="l447">                throw new StorageError(StorageError.ErrorCode.UNSUPPORTED_TYPE, c);
</div><div class="line" id="l448">#endif
</div><div class="line" id="l449">            }
</div><div class="line" id="l450">            <span class="c">return type;</span></div><div class="line" id="l451">        }
</div><div class="line" id="l452"><br></div><div class="line" id="l453">        <span class="c">internal ClassDescriptor()</span></div><div class="line" id="l454">        {
</div><div class="line" id="l455">        <span class="c">}</span></div><div class="line" id="l456"><br></div><div class="line" id="l457">        <span class="c">internal ClassDescriptor(StorageImpl storage, Type cls)</span></div><div class="line" id="l458">        {
</div><div class="line" id="l459">            <span class="c">this.cls = cls;</span></div><div class="line" id="l460">            <span class="c">name = getTypeName(cls);</span></div><div class="line" id="l461">            <span class="c">ArrayList list = new ArrayList();</span></div><div class="line" id="l462">            <span class="c">buildFieldList(storage, cls, list);</span></div><div class="line" id="l463">            <span class="c">allFields = (FieldDescriptor[]) list.ToArray(typeof(FieldDescriptor));</span></div><div class="line" id="l464">            <span class="c">defaultConstructor = cls.GetConstructor(BindingFlags.Instance|BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.DeclaredOnly, null, defaultConstructorProfile, null);</span></div><div class="line" id="l465">            <span class="c">if (defaultConstructor == null &amp;&amp; !typeof(ValueType).IsAssignableFrom(cls))</span></div><div class="line" id="l466">            { 
</div><div class="line" id="l467">                <span class="c">throw new StorageError(StorageError.ErrorCode.DESCRIPTOR_FAILURE, cls);</span></div><div class="line" id="l468">            }
</div><div class="line" id="l469">            <span class="c">resolved = true;</span></div><div class="line" id="l470">        <span class="c">}</span></div><div class="line" id="l471"><br></div><div class="line" id="l472">        internal static Type lookup(Storage storage, String name)
</div><div class="line" id="l473">        {
</div><div class="line" id="l474">            <span class="c">Hashtable resolvedTypes = ((StorageImpl)storage).resolvedTypes;</span></div><div class="line" id="l475">            <span class="c">lock (resolvedTypes)</span></div><div class="line" id="l476">            { 
</div><div class="line" id="l477">                <span class="c">Type cls = (Type)resolvedTypes[name];</span></div><div class="line" id="l478">                <span class="c">if (cls != null)</span></div><div class="line" id="l479">                { 
</div><div class="line" id="l480">                    <span class="c">return cls;</span></div><div class="line" id="l481">                }
</div><div class="line" id="l482">                <span class="c">ClassLoader loader = storage.Loader;</span></div><div class="line" id="l483">                <span class="c">if (loader != null)</span></div><div class="line" id="l484">                { 
</div><div class="line" id="l485">                    <span class="c">cls = loader.LoadClass(name);</span></div><div class="line" id="l486">                    <span class="c">if (cls != null)</span></div><div class="line" id="l487">                    { 
</div><div class="line" id="l488">                        <span class="c">resolvedTypes[name] = cls;</span></div><div class="line" id="l489">                        <span class="c">return cls;</span></div><div class="line" id="l490">                    }
</div><div class="line" id="l491">                }
</div><div class="line" id="l492">                <span class="c">Module last = lastModule;</span></div><div class="line" id="l493">                <span class="c">if (last != null)</span></div><div class="line" id="l494">                {
</div><div class="line" id="l495">                    <span class="c">cls = last.GetType(name);</span></div><div class="line" id="l496">                    <span class="c">if (cls != null)</span></div><div class="line" id="l497">                    {
</div><div class="line" id="l498">                        <span class="c">resolvedTypes[name] = cls;</span></div><div class="line" id="l499">                        <span class="c">return cls;</span></div><div class="line" id="l500">                    }
</div><div class="line" id="l501">                }
</div><div class="line" id="l502"><br></div><div class="line" id="l503">                <span class="c">int p = name.IndexOf('=');</span></div><div class="line" id="l504">                <span class="c">if (p &gt;= 0)</span></div><div class="line" id="l505">                { 
</div><div class="line" id="l506">                    <span class="c">Type genericType = lookup(storage, name.Substring(0, p));</span></div><div class="line" id="l507">                    <span class="c">Type[] genericParams = new Type[genericType.GetGenericArguments().Length];</span></div><div class="line" id="l508">                    <span class="c">int nest = 0;</span></div><div class="line" id="l509">                    <span class="c">int i = p += 2;</span></div><div class="line" id="l510">                    <span class="c">int n = 0;</span></div><div class="line" id="l511"><br></div><div class="line" id="l512">                    while (true)
</div><div class="line" id="l513">                    {   
</div><div class="line" id="l514">                        <span class="c">switch (name[i++])</span></div><div class="line" id="l515">                        {
</div><div class="line" id="l516">                        case '[': 
</div><div class="line" id="l517">                            <span class="c">nest += 1;</span></div><div class="line" id="l518">                            <span class="c">break;</span></div><div class="line" id="l519">                        case ']': 
</div><div class="line" id="l520">                            <span class="c">if (--nest &lt; 0)</span></div><div class="line" id="l521">                            { 
</div><div class="line" id="l522">                                <span class="c">genericParams[n++] = lookup(storage, name.Substring(p, i-p-1));</span></div><div class="line" id="l523">                                Debug.Assert(n == genericParams.Length);
</div><div class="line" id="l524">                                <span class="c">cls = genericType.MakeGenericType(genericParams);</span></div><div class="line" id="l525">                                <span class="c">if (cls == null)</span></div><div class="line" id="l526">                                { 
</div><div class="line" id="l527">                                    <span class="c">throw new StorageError(StorageError.ErrorCode.CLASS_NOT_FOUND, name);</span></div><div class="line" id="l528">                                }
</div><div class="line" id="l529">                                <span class="c">resolvedTypes[name] = cls;</span></div><div class="line" id="l530">                                <span class="c">return cls;</span></div><div class="line" id="l531">                            }   
</div><div class="line" id="l532">                            break;
</div><div class="line" id="l533">                        case ',':
</div><div class="line" id="l534">                            <span class="c">if (nest == 0)</span></div><div class="line" id="l535">                            {
</div><div class="line" id="l536">                                <span class="c">genericParams[n++] = lookup(storage, name.Substring(p, i-p-1));</span></div><div class="line" id="l537">                                <span class="c">p = i;</span></div><div class="line" id="l538">                            }
</div><div class="line" id="l539">                            <span class="c">break;</span></div><div class="line" id="l540">                        }
</div><div class="line" id="l541">                    }
</div><div class="line" id="l542">                }
</div><div class="line" id="l543"><br></div><div class="line" id="l544">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l545">                foreach (Assembly ass in StorageImpl.assemblies) 
</div><div class="line" id="l546">#else
</div><div class="line" id="l547">                foreach (<span class="c">Assembly ass</span> <span class="c">in</span> <span class="c">AppDomain.CurrentDomain.GetAssemblies()</span>)</div><div class="line" id="l548">#endif
</div><div class="line" id="l549">                { 
</div><div class="line" id="l550">                    foreach (<span class="c">Module mod</span> <span class="c">in</span> <span class="c">ass.GetModules()</span>)</div><div class="line" id="l551">                    { 
</div><div class="line" id="l552">                        <span class="c">Type t = mod.GetType(name);</span></div><div class="line" id="l553">                        <span class="c">if (t != null)</span></div><div class="line" id="l554">                        {
</div><div class="line" id="l555">                            <span class="c">if (cls != null)</span></div><div class="line" id="l556">                            { 
</div><div class="line" id="l557">                                <span class="c">throw new StorageError(StorageError.ErrorCode.AMBIGUITY_CLASS, name);</span></div><div class="line" id="l558">                            } 
</div><div class="line" id="l559">                            else 
</div><div class="line" id="l560">                            { 
</div><div class="line" id="l561">                                <span class="c">lastModule = mod;</span></div><div class="line" id="l562">                                <span class="c">cls = t;</span></div><div class="line" id="l563">                            }
</div><div class="line" id="l564">                        }
</div><div class="line" id="l565">                    }
</div><div class="line" id="l566">                }
</div><div class="line" id="l567">#if !COMPACT_NET_FRAMEWORK
</div><div class="line" id="l568">                <span class="c">if (cls == null &amp;&amp; name.EndsWith("Wrapper"))</span></div><div class="line" id="l569">                {
</div><div class="line" id="l570">                    <span class="c">Type originalType = lookup(storage, name.Substring(0, name.Length-7));</span></div><div class="line" id="l571">                    <span class="c">lock (storage)</span></div><div class="line" id="l572">                    {
</div><div class="line" id="l573">                        <span class="c">cls = ((StorageImpl)storage).getWrapper(originalType);</span></div><div class="line" id="l574">                    }
</div><div class="line" id="l575">                }
</div><div class="line" id="l576">#endif
</div><div class="line" id="l577">                <span class="c">if (cls == null)</span></div><div class="line" id="l578">                {
</div><div class="line" id="l579">                    <span class="c">throw new StorageError(StorageError.ErrorCode.CLASS_NOT_FOUND, name);</span></div><div class="line" id="l580">                }
</div><div class="line" id="l581">                <span class="c">resolvedTypes[name] = cls;</span></div><div class="line" id="l582">                <span class="c">return cls;</span></div><div class="line" id="l583">            }
</div><div class="line" id="l584">        <span class="c">}</span></div><div class="line" id="l585"><br></div><div class="line" id="l586">        public override void OnLoad()
</div><div class="line" id="l587">        {
</div><div class="line" id="l588">            <span class="c">cls = lookup(Storage, name);</span></div><div class="line" id="l589">            <span class="c">int n = allFields.Length;</span></div><div class="line" id="l590">            <span class="c">bool hasTransparentAttribute = cls.GetCustomAttributes(typeof(TransparentPersistenceAttribute), true).Length != 0;</span></div><div class="line" id="l591">            for (<span class="c">int i = n;</span> <span class="c">--i &gt;= 0</span>;)</div><div class="line" id="l592">            { 
</div><div class="line" id="l593">                <span class="c">FieldDescriptor fd = allFields[i];</span></div><div class="line" id="l594">                <span class="c">fd.Load();</span></div><div class="line" id="l595">                <span class="c">fd.field = cls.GetField(fd.fieldName, BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);</span></div><div class="line" id="l596">                <span class="c">if (hasTransparentAttribute &amp;&amp; fd.type == FieldType.tpObject &amp;&amp; isPerstInternalType(fd.field.FieldType))</span></div><div class="line" id="l597">                {
</div><div class="line" id="l598">                    <span class="c">fd.recursiveLoading = true;</span></div><div class="line" id="l599">                }                
</div><div class="line" id="l600"><br></div><div class="line" id="l601">                <span class="c">switch (fd.type)</span></div><div class="line" id="l602">                {
</div><div class="line" id="l603">                case FieldType.tpArrayOfOid:
</div><div class="line" id="l604">                    <span class="c">fd.constructor = GetConstructor(fd.field, "ConstructArray");</span></div><div class="line" id="l605">                    <span class="c">break;</span></div><div class="line" id="l606">                case FieldType.tpLink:
</div><div class="line" id="l607">                    <span class="c">fd.constructor = GetConstructor(fd.field, "ConstructLink");</span></div><div class="line" id="l608">                    break;
</div><div class="line" id="l609">                default:
</div><div class="line" id="l610">                    break;
</div><div class="line" id="l611">                }
</div><div class="line" id="l612">            }
</div><div class="line" id="l613"><br></div><div class="line" id="l614">            <span class="c">defaultConstructor = cls.GetConstructor(BindingFlags.Instance|BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.DeclaredOnly, null, defaultConstructorProfile, null);</span></div><div class="line" id="l615">            <span class="c">if (defaultConstructor == null &amp;&amp; !typeof(ValueType).IsAssignableFrom(cls))</span></div><div class="line" id="l616">            { 
</div><div class="line" id="l617">                <span class="c">throw new StorageError(StorageError.ErrorCode.DESCRIPTOR_FAILURE, cls);</span></div><div class="line" id="l618">            }
</div><div class="line" id="l619">            <span class="c">StorageImpl s = (StorageImpl)Storage;</span></div><div class="line" id="l620">            <span class="c">if (!s.classDescMap.Contains(cls))</span></div><div class="line" id="l621">            {
</div><div class="line" id="l622">                <span class="c">((StorageImpl)Storage).classDescMap.Add(cls, this);</span></div><div class="line" id="l623">            }
</div><div class="line" id="l624">        <span class="c">}</span></div><div class="line" id="l625"><br></div><div class="line" id="l626">        internal void resolve() 
</div><div class="line" id="l627">        {
</div><div class="line" id="l628">            <span class="c">if (!resolved)</span></div><div class="line" id="l629">            { 
</div><div class="line" id="l630">                <span class="c">StorageImpl classStorage = (StorageImpl)Storage;</span></div><div class="line" id="l631">                <span class="c">ClassDescriptor desc = new ClassDescriptor(classStorage, cls);</span></div><div class="line" id="l632">                <span class="c">resolved = true;</span></div><div class="line" id="l633">                <span class="c">if (!desc.equals(this))</span></div><div class="line" id="l634">                { 
</div><div class="line" id="l635">                    <span class="c">classStorage.registerClassDescriptor(desc);</span></div><div class="line" id="l636">                }
</div><div class="line" id="l637">            }
</div><div class="line" id="l638">        <span class="c">}</span></div><div class="line" id="l639"><br></div><div class="line" id="l640">        public override bool RecursiveLoading()
</div><div class="line" id="l641">        {
</div><div class="line" id="l642">            <span class="c">return false;</span></div><div class="line" id="l643">        }
</div><div class="line" id="l644">    }
</div><div class="line" id="l645">}</div>
  </pre>
  </td>
  </tr>
</tbody>
</table>
</body>
</html>
Title: scdiff

# What is scdiff?

Imagine this: you've just made changes to code kept in
[CVS](http://www.cvshome.org/), [Subversion](http://subversion.tigris.org/) or
[Git](http://git-scm.com/) repository. You're ready to check them in but you
want to take a last look at the changes. Usually you would do `cvs diff -u` or
`svn diff`. This program allows you to see the changes with an external gui
diff program. I find it much easier to understand the changes that way (as
opposed to looking at unified diff in the console). By default it uses
`windiff.exe` but you can use `-diff` option to select any other program (e.g.
[WinMerge](http://winmerge.org) or [Araxis
Merge](http://www.araxis.com/index.html)) . Clearly, it's a tool for
developers.

### Usage

`scdiff [-h] [-old] [-cvs cvsCommand] [-cvsargs cvsOptions] [-diff
diffProgramPath]`

If you run scdiff without any arguments, it'll determine if a given directory
is under CVS or Subversion control, check for locally modified files and
launch external diff program showing local modifications. By default it uses
windiff (assumes that windiff.exe is in the `%PATH%`) but you can use
**`-diff`** option to use any other diff program that can be launched from
command lind. First two arguments given to the diff program are directories to
diff. This works for all diff programs I've tested it (windiff, WinMerge and
Araxis Merge).

By its nature (see how it works for more explanation) scdiff uses temporary
directory for storing original and modified files so even after you finish,
you can still see the result of previous diff. Option `-old` does exactly
that. It saves the time (getting files from repository may take some time).

To see built-in help, use `-h` option.

Option `-cvs` defaults to "cvs -z3". Option `-cvsargs` defaults to "-u -N". In
theory you shouldn't need to change them.

### Download

Download [scdiff.exe](http://kjkpub.s3.amazonaws.com/files/scdiff.exe).
Requires .NET Framework 2.0.

### Source code

You can get the sources from [project
site](http://code.google.com/p/kjk/source/browse/#svn/trunk/vctools/scdiff).

### Version history

0.5 (2009-03-11):

  * added Git support

0.4 (2004-12-08):

  * add `-cvs` parameter to provide the name of cvs executable. Default is "cvs -z3".
  * add `-cvsargs` parameter to provide additional args to cvs. Default is "-u -N"
  * fixes for handling new and deleted files in cvs  All 0.4 changes provided by [dB](http://www.dblock.org).

0.3 (2004-10-02):

  * [Eli Tucker](http://nerdmonkey.com) fixed a bug handling directories in cvs
  * no longer crash when handling `svn remove`. Still, handling of deleting files is far from perfect (currently they are silently ignored while we should show apropriate diff)
  * properly handle file names with spaces. Fix suggested by Raman Gupta

0.2 (2004-06-08):

  * now also shows files that only exists locally and are not present in `cvs` repository. If that bothers you, learn how to use `.cvsignore`
  * show version number when displaying help

0.1 (2004-06-03):

  * first version

### How it works

Not that it's terribly interesting, but just in case you were wondering.
First, we capture the output of `cvs diff -u` or `svn diff`. From that we
extract names of the files that are locally modified and the revision number
of the file before modifications. The we check out the originals (using `cvs
update -p -r rev` or svn cat ...), copy the originals to
`$tempDir/sc_originals`, our locally modified copies to `$tempDir/sc_altered`
and launch external diff program with `$tempDir/sc_originals` and
`$tempDir/sc_altered` as arguments. Pretty simple and possibly suboptimal
(subversion can do a diff without contacting remote repository, so it should
be possible to significantly speed up the program if I knew how to get the
original without asking remote repository).

### Todo

It's really a quick & dirty program, so there's potential for a lot of stuff
to be done. In the "blue sky" departement, I would like to have a full-fledged
program for browsing changes in CVS or Subversion repositories. And no, it's
not about re-writing [WinCVS](http://www.wincvs.org/) and the like for the fun
of it. WinCVS does much more that what I need my ideal program to do, but it
also doesn't do what I want (easily end efficiently browse changes).

But that's unlikely to happen, so here's a couple of things that could be
fixed:

  * as noted in "how it works", it should be possible to make Subversion case work without contacting remote repository
  * currently you can't launch two copies at the same time because they use the same temp directory for storing files so the second copy will be unable to access temp directory
  * currently windiff.exe must be in path. Could try to auto-detect full path by checking known paths or maybe looking in the registry
  * auto-detect other diff programs like WinMerge and Araxis Merge
  * downloading revisions from the repository takes time. Revisions do not change so they are perfect target for caching. We could locally cache revisions we retrieved so far to speed up a case of comparing local changes with the same revision multiple times. It happens quite often (we often get into develop/compare/fix/compare/fix/compare... cycle)

### Links

  * [CVS](http://cvshome.org) and [Subversion](http://subversion.tigris.org/) are source control systems. Use Subversion if you have a choice
  * [Windiff](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/tools/tools/windiff.asp), [WinMerge](http://winmerge.org), [Araxis Merge](http://www.araxis.com/index.html) are diff/merge programs. [There are others](http://keithdevens.com/downloads#diff).
  * [WinCVS](http://www.wincvs.org/) is a GUI for managing CVS. It doesn't do what I need.

### Feedback

As noted, this program is simple, does one thing that is useful to me. It
might never get any better and there's not much to talk about. If you,
however, have a burning desire to talk to me about it (you know, comments, bug
reports, suggestions etc.), you can always [send me an e-mail](/).


